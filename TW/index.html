<!DOCTYPE html>
<html>
<head>
    <title>ThinkWord</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .tela {
            display: none;
        }
        .tela.ativa {
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #chat {
            width: 100%;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #chat>div {
            padding: 3px;
            display: flex;
        }
        #chat>div.right {
            justify-content: flex-end;
        }
        #chat>div.center {
            justify-content: center;
        }

        #chat>div>p {
            padding: 4px;
            border-radius: 3px;
            word-break: break-word;
            max-width: 90%;
        }
        #chat>div>.me {
            background-color: rgb(168, 255, 183);
            color: rgb(0, 59, 10);
        }
        #chat>div>.srv {
            background-color: rgb(231, 231, 231);
            color: rgb(66, 66, 66);
        }        
        #chat>div>.pww {
            background-color: rgb(19, 255, 70);
            color: rgb(0, 43, 4);
        }      
        #chat>div>.pwl {
            background-color: rgb(255, 149, 9);
            color: rgb(66, 0, 0);
        }
        #chat>div>.other {
            background-color: rgb(173, 232, 255);
            color: rgb(0, 39, 56);
        }
        .rc-room {
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            margin: 5px 0;
            padding: 5px;
        }
        .rc-room:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .rc-room>div{
            display: flex;
            flex-direction: row;
            gap: 4px;
            flex-wrap: wrap;
        }
        .rc-room>div>p {
            border-bottom: 1px solid black;
        }
    </style>
</head>
<body>
    <div>
        <button id="change-tela">ChangeTela</button>
    </div>

    <div id="tela-main" class="tela ativa">
        <div id="name-input-block">
            <div id="name-input-container">
                <p>Nome</p>
                <div>
                    <input id="name-input" type="text" placeholder="Seu nome..." />
                    <button id="name-submit"> OK </button>
                </div>
            </div>
        </div>
        <div id="room-list-block">
            <div id="room-list-container">
                <div id="room-list-header">
                    <input type="text" id="room-name-input" placeholder="Nome da Sala" />
                    <button id="join-room">Entrar</button>
                    <button id="create-room">Criar</button>
                    <button id="reload-rooms">Recarregar</button>
                </div>
                <div id="room-list-content">
                    <!-- Lista de salas
                    <div class="rl-room">
                        <div class="rl-room-info">
                            <p>Nome da Sala</p>
                            <div>
                                <p>Jogador 1</p>
                                <p>Jogador 2...</p>
                            </div>
                        </div>
                        <button> Entrar </button>
                    </div>
                     -->
                </div>
            </div>
        </div>
    </div>
    <div id="tela-room" class="tela">
        <div id="room-ins-header">
            <p> Nome da sala</p>
        </div>
        <div id="room-ins-content">
            <div id="room-ins-gamestate">
                <div id="room-ins-gs">

                </div>
                <div id="room-ins-playertyping">                    

                </div>
            </div>
            <div id="room-ins-game">
                <div id="room-ins-players">
                    <!-- <p> jogador1... </p> -->
                </div>
                <div id="room-ins-chat">
                    <!-- Mensagens do chat da sala -->
                </div>
            </div>
        </div>
        <div id="room-ins-footer">
            <div>
                <input type="text" id="room-ins-input" placeholder="Digite uma mensagem..." />
                <button id="room-ins-send">Enviar</button>
            </div>
            <div>
                <button> Sair </button>
                <button> Iniciar Jogo </button>
            </div>
        </div>
    </div>

    <h1>ThinkWord</h1>
    <div id="chat"></div>
    <p id="game-state"></p>
    <input id="message" type="text" placeholder="Type a message..." />
    <p id="player-typing"></p>
    <p id="identity"></p>
    <p id="room-players"></p>
    <button id="send">Send</button>
    <button id="start">Start Game</button>
    <button id="ping">Ping</button>
    <button id="setname">Set Name</button>
    <button id="rooms">List Rooms</button>
    <button id="createroom">Create Room</button>
    <button id="joinroom">Join Room</button>
    <button id="leaveroom">Leave Room</button>

    <script>
        const chat = document.getElementById("chat");
        const gameState = document.getElementById("game-state");
        const messageInput = document.getElementById("message");
        const playerTyping = document.getElementById("player-typing");
        const sendButton = document.getElementById("send");
        const startButton = document.getElementById("start");
        const pingButton = document.getElementById("ping");
        const setNameButton = document.getElementById("setname");
        const roomsButton = document.getElementById("rooms");
        const createRoomButton = document.getElementById("createroom");
        const joinRoomButton = document.getElementById("joinroom");
        const leaveRoomButton = document.getElementById("leaveroom");
        const identity = document.getElementById("identity");
        const roomPlayers = document.getElementById("room-players");
        const changeTelaButton = document.getElementById("change-tela");

        changeTelaButton.onclick = changeTela;

        function changeTela() {
            const mainTela = document.getElementById("tela-main");
            const roomTela = document.getElementById("tela-room");

            if (mainTela.classList.contains("ativa")) {
                mainTela.classList.remove("ativa");
                roomTela.classList.add("ativa");
            } else {
                mainTela.classList.add("ativa");
                roomTela.classList.remove("ativa");
            }
        }


        let gameState_value = 0;
        let me = { id: -1, name: "Player" };
        let room_players = {};

        let ws = null;        
        function wsOnOpen() {
            console.log("WS connected");
        }
        function wsOnClose() {
            console.log("WS disconnected");
            gameState_value = 0;
            setTimeout(setupWS, 3000);
        }
        function wsOnMesssage(event) {
            msg = JSON.parse(event.data);
            console.log("WS message received:", msg);
            switch (msg.t) {
                case "errtable": // Error table
                    ERRORTABLE = msg.e;
                    break;
                case "err": // Error message
                    handleError(msg.e)
                    break;
                case "rc": // Room chat message
                    addToRoomChat(msg.m, msg.f);
                    break;
                case "rl": // Room list
                    showRoomListInChat(msg.r);
                    break;
                case "gs": // Game state update
                    updateGameState(msg.s, msg.p);
                    break;
                case "pt": // Game text message
                    updatePlayerTyping(msg.m);
                    break;
                case "pw": // Player word message
                    showResultInChat(msg.m, msg.r);
                    break;
                case "id": // Identity message
                    me.id = msg.p;
                    me.name = msg.n;
                    identity.textContent = `${me.name} (ID: ${me.id})`;
                    addToRoomChat(`Olá ${me.name}`, -1);
                    break;
                case "pid": // Player IDs
                    player = { [msg.p]: msg.n };
                    updateRoomPlayers(player, false);
                    addToRoomChat(`O jogador ${msg.n} entrou na sala`, -1);
                    break;
                case "pids": // Player IDs
                    updateRoomPlayers(msg.p, false);
                    break;
                case "pl": // Player left
                    const playerName = room_players[msg.p];
                    addToRoomChat(`O jogador ${playerName} saiu da sala`, -1);
                    player = { [msg.p]: playerName };
                    updateRoomPlayers(player, true);
                    break;

            }
        }
        function setupWS() {
            ws = new WebSocket("ws://localhost:15765");
            ws.onopen = wsOnOpen;
            ws.onclose = wsOnClose;
            ws.onmessage = wsOnMesssage;
        }

        ERRORTABLE = {}
        async function handleError(err) {
            if (Object.keys(ERRORTABLE).length === 0) {
                await ws.send(fMsgToSend("command", "errtable"));
                await setTimeout(() => {
                    handleError(err);
                }, 1000);
                return;
            }
            addToRoomChat(`Error: ${ERRORTABLE[err] || "Unknown error"}`, -1);
        }

        function addToRoomChat(msg, from) {
            const msgElement = document.createElement("p");

            const div = document.createElement("div");

            if (from == -1) {
                div.classList.add("center");
                msgElement.classList.add("srv");
            } else if (from >= 0) {
                let playerName = room_players[from];
                msg = `${playerName}: ${msg}`;
                msgElement.classList.add("other");
            } else {
                div.classList.add("center");
                msgElement.classList.add("other");
            }

            msgElement.textContent = msg;

            div.appendChild(msgElement);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        };

        function showResultInChat(msg, result) {            
            const msgElement = document.createElement("p");
            msgElement.textContent = msg;

            const div = document.createElement("div");
            div.classList.add("center");

            console.log("Result: ", result);
            switch (result) {
                case 1: // Player win 
                    msgElement.classList.add("pww");
                    break;
                case 0: // Player lose
                    msgElement.classList.add("pwl");
                    break;
            }

            updatePlayerTyping("");

            div.appendChild(msgElement);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function showRoomListInChat(rooms) {
            const line = document.createElement("div");
            line.classList.add("center");
            
            const holder = document.createElement("div");
            holder.classList.add("holder-room");

            for (const [roomCode, players] of Object.entries(rooms)) {
                const room = document.createElement("div");
                room.classList.add("rc-room");

                room.addEventListener("click", () => {
                    ws.send(fMsgToSend("command", roomCode, "join"));
                });

                const rcode = document.createElement("p");
                rcode.textContent = roomCode;

                room.appendChild(rcode);

                const div = document.createElement("div");

                for (const player of players) {
                    const p = document.createElement("p");
                    p.textContent = player;

                    div.appendChild(p);
                }

                room.appendChild(div);
                holder.appendChild(room);
            }
            line.appendChild(holder);
            chat.appendChild(line);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateRoomPlayers(pids, remover = false) {            
            
            if (remover) {
                Object.entries(pids).forEach(([pid, name]) => {
                    delete room_players[pid];
                });
            } else {
                Object.entries(pids).forEach(([pid, name]) => {
                    room_players[pid] = name;
                });
            }

            roomPlayers.textContent = "Players: " + Object.values(room_players).join(", ");
        }

        function updatePlayerTyping(typing) {
            if (typing.length > 0) {
                playerTyping.textContent = typing;
            } else {
                playerTyping.textContent = "...";
            }
        }

        function updateGameState(state, pid_chosen = null) {
            gameState.textContent = "Game State: " + state;
            gameState_value = state;

            if (pid_chosen !== null) {
                if (pid_chosen == me.id) {
                    gameState.textContent += " (You are the chosen player)";
                    gameState_value = 4;
                } else {
                    const playerName = room_players[pid_chosen];
                    gameState.textContent += " (Chosen Player: " + playerName + ")";
                }
            }
        }

        function fMsgToSend(type, msg, comm) {
            if (comm) msg = `${comm}:${msg}`;
            switch (type) {
                case "command":
                    return JSON.stringify({ c: msg });
                case "roomchat":
                    return JSON.stringify({ r: msg });
                case "gamemsg":
                    return JSON.stringify({ g: msg });
            }
        }

        setupWS();

        // Envia o que o usuario estiver digitando em tempo real
        messageInput.oninput = () => {
            if (gameState_value == 4) {
                const msg = messageInput.value;
                ws.send(fMsgToSend("gamemsg", msg, "t"));
            }
        };

        messageInput.onkeyup = (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                sendButton.click();
            }
        };

        // Iniciar o jogo
        startButton.onclick = () => {
            ws.send(fMsgToSend("gamemsg", "start"));
        };

        // pingpong
        pingButton.onclick = () => {
            ws.send(fMsgToSend("command", "ping"));
        };

        // Definir o nome do usuário
        setNameButton.onclick = () => {
            const name = prompt("Enter your name:");
            if (name) {
                ws.send(fMsgToSend("command", name, "me"));
            }
        };

        // Listar as salas
        roomsButton.onclick = () => {
            ws.send(fMsgToSend("command", "rooms"));
        };

        // Criar uma sala
        createRoomButton.onclick = () => {
            const roomName = prompt("Enter room name:");
            if (roomName) {
                ws.send(fMsgToSend("command", roomName, "create"));
            }
        };

        // Entrar em uma sala
        joinRoomButton.onclick = () => {
            const roomName = prompt("Enter room name:");
            if (roomName) {
                ws.send(fMsgToSend("command", roomName, "join"));
            }
        };

        // Sair da sala
        leaveRoomButton.onclick = () => {
            ws.send(fMsgToSend("roomchat", "leave"));
            roomPlayers.textContent = "Players: ";
            room_players = {};
            playerTyping.textContent = "...";
        };

        sendButton.onclick = () => {
            const msg = messageInput.value;

            if (gameState_value == 4) {
                ws.send(fMsgToSend("gamemsg", msg, "m"));
            } else {
                ws.send(fMsgToSend("roomchat", msg, "c"));            
                const msgElement = document.createElement("p");
                msgElement.textContent = msg;
                msgElement.classList.add("me");

                const div = document.createElement("div");
                div.classList.add("right");
                div.appendChild(msgElement);
                chat.appendChild(div);
            }
            chat.scrollTop = chat.scrollHeight;

            messageInput.value = "";
        };
    </script>
</body>
</html>