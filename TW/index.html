<!DOCTYPE html>
<html>
<head>
    <title>ThinkWord</title>
    <link rel="stylesheet" href="telamain.css">
    <link rel="stylesheet" href="telaroom.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .tela {
            display: none;
            max-width: 400px;
        }
        .tela.ativa {
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
        }


        #toast-messages-window.hidden {
            display: none;
        }
        #toast-messages-window {
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: right;
            z-index: 1000;
        }
        #toast-messages {
            width: 300px;
            display: flex;
            flex-direction: column-reverse;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            
            border-radius: 5px;
        }
        .toast {
            background-color: black;
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        .toast.success {
            background-color: rgba(173, 221, 173, 0.5);
            color: rgb(0, 61, 0);
        }
        .toast.error {
            background-color: rgba(255, 173, 173, 0.5);
            color: rgb(61, 0, 0);
        }
        .toast.info {
            background-color: rgba(173, 173, 255, 0.5);
            color: rgb(0, 0, 61);
        }
    </style>
</head>
<body>
    <div id="toast-messages-window" class="hidden">
        <div id="toast-messages">
            <!--
            <div class="toast success">
                <p>Mensagem de sucesso</p>
            </div>
            <div class="toast error">
                <p>Mensagem de erro</p>
            </div>
            <div class="toast info">
                <p>Mensagem informativa</p>
            </div>
            -->
        </div>
    </div>
    <div id="tela-main-page" class="tela ativa">
        <div id="tela-main">
            <div id="name-input-block">
                <div id="name-input-container">
                    <p>Nome</p>
                    <div>
                        <input id="name-input" type="text" placeholder="Seu nome..." />
                        <button id="name-submit"> OK </button>
                    </div>
                </div>
            </div>
            <div id="room-list-block">
                <div id="room-list-container">
                    <div id="room-list-header">
                        <input type="text" id="room-name-input" placeholder="Nome da Sala" />
                        <button id="join-room">Entrar</button>
                        <button id="create-room">Criar</button>
                        <button id="reload-rooms">Recarregar</button>
                    </div>
                    <div id="room-list-content">
                        <!-- Lista de salas
                        <div class="rl-room">
                            <div class="rl-room-info">
                                <p>Nome da Sala</p>
                                <div>
                                    <p>Jogador 1...</p>
                                </div>
                            </div>
                            <button> Entrar </button>
                        </div>
                        -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tela-room-page" class="tela">
        <div id="tela-room">
            <div id="room-ins-header">
                <p id="room-name">Nome da sala</p>
            </div>
            <div id="room-ins-content">
                <div id="room-ins-gamestate">
                    <div id="room-ins-gs">
                        
                    </div>
                    <div id="room-ins-playertyping">

                    </div>
                </div>
                <div id="room-ins-game">
                    <div id="room-ins-players">
                        <!--
                        <p class="playing"> jogador2 </p>
                        <p> jogador3 </p>
                        <p class="me playing"> jogador1 </p>
                        <p> jogador2 </p>
                        <p class="me"> jogador4 </p>
                        -->
                    </div>
                    <div id="room-ins-chat">
                        <!--
                        <div class="right">
                            <p class="me"> minha mensagem </p>
                        </div>
                        <div class="center">
                            <p class="srv"> mensagem do servidor </p>
                        </div>
                        <div>
                            <p class="other"> mensagens de outros players </p>
                        </div>
                        -->
                    </div>
                </div>
            </div>
            <div id="room-ins-footer">
                <div id="room-ins-input-cont">
                    <input type="text" id="room-ins-input" placeholder="Digite uma mensagem..." />
                    <button id="room-ins-send">Enviar</button>
                </div>
                <div id="room-ins-buttons">
                    <button id="room-ins-leaveroom"> Sair </button>
                    <button id="room-ins-startgame"> Iniciar Jogo </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chat = document.getElementById("room-ins-chat");
        const gameState = document.getElementById("room-ins-gs");
        const playerTyping = document.getElementById("room-ins-playertyping");
        const startButton = document.getElementById("room-ins-startgame");
        const leaveRoomButton = document.getElementById("room-ins-leaveroom");
        const roomsButton = document.getElementById("reload-rooms");
        const roomPlayers = document.getElementById("room-ins-players");
        const createRoomButton = document.getElementById("create-room");
        
        const nameInputContainer = document.getElementById("name-input-container");
        const nameInput = document.getElementById("name-input");
        const setNameButton = document.getElementById("name-submit");

        const messageInput = document.getElementById("room-ins-input");
        const sendButton = document.getElementById("room-ins-send");        
        
        const roomNameP = document.getElementById("room-name");
        const roomNameInput = document.getElementById("room-name-input");
        const joinRoomButton = document.getElementById("join-room");
        
        
        const toastMessagesWindow = document.getElementById("toast-messages-window");
        const toastMessages = document.getElementById("toast-messages");

        function addToastMessage(message, type = "info") {
            const toast = document.createElement("div");
            toast.classList.add("toast", type);
            toast.textContent = message;

            toastMessages.appendChild(toast);
            toastMessagesWindow.classList.remove("hidden");

            setTimeout(() => {
                toast.remove();
                if (toastMessages.children.length === 0) {
                    toastMessagesWindow.classList.add("hidden");
                }
            }, 3000);
        }


        function changeTela() {
            const mainTela = document.getElementById("tela-main-page");
            const roomTela = document.getElementById("tela-room-page");

            if (mainTela.classList.contains("ativa")) {
                mainTela.classList.remove("ativa");
                roomTela.classList.add("ativa");
            } else {
                mainTela.classList.add("ativa");
                roomTela.classList.remove("ativa");
            }
        }


        let gameState_value = 0;
        let me = { id: -1, name: "Player" };
        let room_players = {};

        let ws = null;        
        function wsOnOpen() {
            console.log("WS connected");
        }
        function wsOnClose() {
            console.log("WS disconnected");
            gameState_value = 0;
            setTimeout(setupWS, 3000);
        }
        function wsOnMesssage(event) {
            msg = JSON.parse(event.data);
            console.log("WS message received:", msg);
            switch (msg.t) {
                case "errtable": // Error table
                    ERRORTABLE = msg.e;
                    break;
                case "err": // Error message
                    handleError(msg.e)
                    break;
                case "rc": // Room chat message
                    addToRoomChat(msg.m, msg.f);
                    break;
                case "rl": // Room list
                    showRoomList(msg.r);
                    break;
                case "er": // Entering room
                    enterRoom(msg.r);
                    break;
                case "gs": // Game state update
                    updateGameState(msg.s, msg.p);
                    break;
                case "pt": // Game text message
                    updatePlayerTyping(msg.m);
                    break;
                case "pw": // Player word message
                    showResultInChat(msg.m, msg.r);
                    break;
                case "id": // Identity message
                    setPlayerId(msg.p, msg.n);
                    break;
                case "pid": // Player IDs
                    player = { [msg.p]: msg.n };
                    modifyRoomPlayerList(player, false);
                    addToRoomChat(`O jogador ${msg.n} entrou na sala`, -1);
                    break;
                case "pids": // Player IDs
                    modifyRoomPlayerList(msg.p, false);
                    break;
                case "pl": // Player left
                    const playerName = room_players[msg.p];
                    addToRoomChat(`O jogador ${playerName} saiu da sala`, -1);
                    player = { [msg.p]: playerName };
                    modifyRoomPlayerList(player, true);
                    break;

            }
        }
        function setupWS() {
            ws = new WebSocket("ws://10.8.0.10:15765");
            ws.onopen = wsOnOpen;
            ws.onclose = wsOnClose;
            ws.onmessage = wsOnMesssage;
        }

        ERRORTABLE = {}
        async function handleError(err) {
            if (Object.keys(ERRORTABLE).length === 0) {
                await ws.send(fMsgToSend("command", "errtable"));
                await setTimeout(() => {
                    handleError(err);
                }, 1000);
                return;
            }
            addToastMessage(`Error: ${ERRORTABLE[err] || "Unknown error"}`, "error");
        }

        function setPlayerId(id, name) {
            me.id = id;
            me.name = name;
            nameInputContainer.innerHTML = `<p>Olá ${me.name} !</p>`;
        }

        function addToRoomChat(msg, from) {
            const msgElement = document.createElement("p");

            const div = document.createElement("div");

            if (from == -1) {
                div.classList.add("center");
                msgElement.classList.add("srv");
            } else if (from >= 0) {
                let playerName = room_players[from];
                msg = `${playerName}: ${msg}`;
                msgElement.classList.add("other");
            } else {
                div.classList.add("center");
                msgElement.classList.add("other");
            }

            msgElement.textContent = msg;

            div.appendChild(msgElement);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        };

        function showResultInChat(msg, result) {            
            const msgElement = document.createElement("p");
            msgElement.textContent = msg;

            const div = document.createElement("div");
            div.classList.add("center");

            console.log("Result: ", result);
            switch (result) {
                case 1: // Player win 
                    msgElement.classList.add("pww");
                    break;
                case 0: // Player lose
                    msgElement.classList.add("pwl");
                    break;
            }

            updatePlayerTyping("");

            div.appendChild(msgElement);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function enterRoom(roomCode) {
            roomNameP.textContent = roomCode;
            if (roomCode == -1) {
                leavingRoom();
            }
            changeTela();
        }

        function leavingRoom() {
            chat.innerHTML = "";
            room_players = {};
            roomPlayers.innerHTML = "";
            playerTyping.textContent = "...";
        }

        function showRoomList(rooms) {
            const roomListContent = document.getElementById("room-list-content");
            roomListContent.innerHTML = "";

            for (const [roomCode, players] of Object.entries(rooms)) {
                const room = document.createElement("div");
                room.classList.add("rl-room");

                const roomInfo = document.createElement("div");
                roomInfo.classList.add("rl-room-info");

                const rcode = document.createElement("p");
                rcode.textContent = roomCode;

                const playerDiv = document.createElement("div");
                for (const player of players) {
                    const p = document.createElement("p");
                    p.textContent = player;
                    playerDiv.appendChild(p);
                }

                roomInfo.appendChild(rcode);
                roomInfo.appendChild(playerDiv);
                room.appendChild(roomInfo);

                const joinButton = document.createElement("button");
                joinButton.textContent = "Entrar";
                joinButton.onclick = () => {
                    ws.send(fMsgToSend("command", roomCode, "join"));
                };

                room.appendChild(joinButton);
                roomListContent.appendChild(room);
            }
        }

        function refreshRoomPlayers(playing_pid = -1) {            
            roomPlayers.innerHTML = "";
            Object.entries(room_players).forEach(([pid, name]) => {
                const p = document.createElement("p");
                p.textContent = name;
                if (pid == me.id) {
                    p.classList.add("me");
                }
                if (pid == playing_pid) {
                    p.classList.add("playing");
                }
                roomPlayers.appendChild(p);
            });
        }

        function modifyRoomPlayerList(pids, remover = false) {            
            
            if (remover) {
                Object.entries(pids).forEach(([pid, name]) => {
                    delete room_players[pid];
                });
            } else {
                Object.entries(pids).forEach(([pid, name]) => {
                    room_players[pid] = name;
                });
            }

            refreshRoomPlayers();

        }

        function updatePlayerTyping(typing) {
            if (typing.length > 0) {
                playerTyping.textContent = typing;
            } else {
                playerTyping.textContent = "...";
            }
        }

        function updateGameState(state, pid_chosen = null) {
            gameState.textContent = "Game State: " + state;
            gameState_value = state;

            if (pid_chosen !== null) {
                if (pid_chosen == me.id) {
                    gameState.textContent += " (You are the chosen player)";
                    gameState_value = 4;
                    addToastMessage("Você é o jogador escolhido!", "info");
                } else {
                    const playerName = room_players[pid_chosen];
                    gameState.textContent += " (Chosen Player: " + playerName + ")";
                }
                refreshRoomPlayers(pid_chosen);
            }
        }

        function fMsgToSend(type, msg, comm) {
            if (comm) msg = `${comm}:${msg}`;
            switch (type) {
                case "command":
                    return JSON.stringify({ c: msg });
                case "roomchat":
                    return JSON.stringify({ r: msg });
                case "gamemsg":
                    return JSON.stringify({ g: msg });
            }
        }

        setupWS();

        // Envia o que o usuario estiver digitando em tempo real
        messageInput.oninput = () => {
            if (gameState_value == 4) {
                const msg = messageInput.value;
                ws.send(fMsgToSend("gamemsg", msg, "t"));
            }
        };

        messageInput.onkeyup = (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                sendButton.click();
            }
        };

        // Iniciar o jogo
        startButton.onclick = () => {
            ws.send(fMsgToSend("gamemsg", "start"));
        };


        nameInput.onkeyup = (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                setNameButton.click();
            }
        };

        // Definir o nome do usuário
        setNameButton.onclick = () => {
            const name = nameInput.value.trim();
            if (name) {
                ws.send(fMsgToSend("command", name, "me"));
            }
        };

        // Listar as salas
        roomsButton.onclick = () => {
            ws.send(fMsgToSend("command", "rooms"));
        };

        // Criar uma sala
        createRoomButton.onclick = () => {
            const roomName = roomNameInput.value.trim();
            if (roomName) {
                ws.send(fMsgToSend("command", roomName, "create"));
            }
        };

        // Entrar em uma sala
        joinRoomButton.onclick = () => {
            const roomName = roomNameInput.value.trim();
            if (roomName) {
                ws.send(fMsgToSend("command", roomName, "join"));
            }
        };

        // Sair da sala
        leaveRoomButton.onclick = () => {
            ws.send(fMsgToSend("roomchat", "leave"));
        };

        sendButton.onclick = () => {
            const msg = messageInput.value.trim();
            if (msg.length === 0) return;

            if (gameState_value == 4) {
                ws.send(fMsgToSend("gamemsg", msg, "m"));
            } else {
                ws.send(fMsgToSend("roomchat", msg, "c"));            
                const msgElement = document.createElement("p");
                msgElement.textContent = msg;
                msgElement.classList.add("me");

                const div = document.createElement("div");
                div.classList.add("right");
                div.appendChild(msgElement);
                chat.appendChild(div);
            }
            chat.scrollTop = chat.scrollHeight;

            messageInput.value = "";
        };
    </script>
</body>
</html>